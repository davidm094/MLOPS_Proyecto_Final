# Prometheus Stack (includes Prometheus, Grafana, AlertManager)
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: prometheus-stack
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    chart: kube-prometheus-stack
    repoURL: https://prometheus-community.github.io/helm-charts
    targetRevision: 55.5.0
    helm:
      values: |
        # Global settings
        fullnameOverride: prometheus
        
        # Prometheus
        prometheus:
          prometheusSpec:
            serviceMonitorSelectorNilUsesHelmValues: false
            podMonitorSelectorNilUsesHelmValues: false
            retention: 7d
            storageSpec:
              volumeClaimTemplate:
                spec:
                  storageClassName: local-path
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 5Gi
            additionalScrapeConfigs:
              - job_name: 'mlops-api'
                kubernetes_sd_configs:
                  - role: pod
                    namespaces:
                      names:
                        - mlops
                relabel_configs:
                  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
                    action: keep
                    regex: true
                  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
                    action: replace
                    target_label: __metrics_path__
                    regex: (.+)
                  - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
                    action: replace
                    regex: ([^:]+)(?::\d+)?;(\d+)
                    replacement: $1:$2
                    target_label: __address__
          service:
            type: NodePort
            nodePort: 30090
        
        # Grafana
        grafana:
          enabled: true
          adminPassword: admin
          service:
            type: NodePort
            nodePort: 30300
          persistence:
            enabled: true
            storageClassName: local-path
            size: 2Gi
          dashboardProviders:
            dashboardproviders.yaml:
              apiVersion: 1
              providers:
                - name: 'default'
                  orgId: 1
                  folder: 'MLOps'
                  type: file
                  disableDeletion: false
                  editable: true
                  options:
                    path: /var/lib/grafana/dashboards/default
          dashboards:
            default:
              mlops-api:
                json: |
                  {
                    "annotations": {
                      "list": []
                    },
                    "editable": true,
                    "fiscalYearStartMonth": 0,
                    "graphTooltip": 0,
                    "id": null,
                    "links": [],
                    "liveNow": false,
                    "panels": [
                      {
                        "datasource": {
                          "type": "prometheus",
                          "uid": "prometheus"
                        },
                        "fieldConfig": {
                          "defaults": {
                            "color": {
                              "mode": "palette-classic"
                            },
                            "custom": {
                              "axisCenteredZero": false,
                              "axisColorMode": "text",
                              "axisLabel": "",
                              "axisPlacement": "auto",
                              "barAlignment": 0,
                              "drawStyle": "line",
                              "fillOpacity": 10,
                              "gradientMode": "none",
                              "hideFrom": {
                                "legend": false,
                                "tooltip": false,
                                "viz": false
                              },
                              "lineInterpolation": "linear",
                              "lineWidth": 1,
                              "pointSize": 5,
                              "scaleDistribution": {
                                "type": "linear"
                              },
                              "showPoints": "never",
                              "spanNulls": false,
                              "stacking": {
                                "group": "A",
                                "mode": "none"
                              },
                              "thresholdsStyle": {
                                "mode": "off"
                              }
                            },
                            "mappings": [],
                            "thresholds": {
                              "mode": "absolute",
                              "steps": [
                                {
                                  "color": "green",
                                  "value": null
                                }
                              ]
                            },
                            "unit": "reqps"
                          },
                          "overrides": []
                        },
                        "gridPos": {
                          "h": 8,
                          "w": 12,
                          "x": 0,
                          "y": 0
                        },
                        "id": 1,
                        "options": {
                          "legend": {
                            "calcs": ["mean", "max"],
                            "displayMode": "table",
                            "placement": "bottom",
                            "showLegend": true
                          },
                          "tooltip": {
                            "mode": "single",
                            "sort": "none"
                          }
                        },
                        "targets": [
                          {
                            "datasource": {
                              "type": "prometheus",
                              "uid": "prometheus"
                            },
                            "expr": "rate(http_requests_total{handler=\"/predict\"}[5m])",
                            "legendFormat": "Predictions/sec",
                            "refId": "A"
                          }
                        ],
                        "title": "Prediction Requests Rate",
                        "type": "timeseries"
                      },
                      {
                        "datasource": {
                          "type": "prometheus",
                          "uid": "prometheus"
                        },
                        "fieldConfig": {
                          "defaults": {
                            "color": {
                              "mode": "palette-classic"
                            },
                            "custom": {
                              "axisCenteredZero": false,
                              "axisColorMode": "text",
                              "axisLabel": "",
                              "axisPlacement": "auto",
                              "barAlignment": 0,
                              "drawStyle": "line",
                              "fillOpacity": 10,
                              "gradientMode": "none",
                              "hideFrom": {
                                "legend": false,
                                "tooltip": false,
                                "viz": false
                              },
                              "lineInterpolation": "linear",
                              "lineWidth": 1,
                              "pointSize": 5,
                              "scaleDistribution": {
                                "type": "linear"
                              },
                              "showPoints": "never",
                              "spanNulls": false,
                              "stacking": {
                                "group": "A",
                                "mode": "none"
                              },
                              "thresholdsStyle": {
                                "mode": "off"
                              }
                            },
                            "mappings": [],
                            "thresholds": {
                              "mode": "absolute",
                              "steps": [
                                {
                                  "color": "green",
                                  "value": null
                                },
                                {
                                  "color": "yellow",
                                  "value": 0.5
                                },
                                {
                                  "color": "red",
                                  "value": 1
                                }
                              ]
                            },
                            "unit": "s"
                          },
                          "overrides": []
                        },
                        "gridPos": {
                          "h": 8,
                          "w": 12,
                          "x": 12,
                          "y": 0
                        },
                        "id": 2,
                        "options": {
                          "legend": {
                            "calcs": ["mean", "max", "p95"],
                            "displayMode": "table",
                            "placement": "bottom",
                            "showLegend": true
                          },
                          "tooltip": {
                            "mode": "single",
                            "sort": "none"
                          }
                        },
                        "targets": [
                          {
                            "datasource": {
                              "type": "prometheus",
                              "uid": "prometheus"
                            },
                            "expr": "histogram_quantile(0.50, rate(http_request_duration_seconds_bucket{handler=\"/predict\"}[5m]))",
                            "legendFormat": "p50",
                            "refId": "A"
                          },
                          {
                            "datasource": {
                              "type": "prometheus",
                              "uid": "prometheus"
                            },
                            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{handler=\"/predict\"}[5m]))",
                            "legendFormat": "p95",
                            "refId": "B"
                          },
                          {
                            "datasource": {
                              "type": "prometheus",
                              "uid": "prometheus"
                            },
                            "expr": "histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{handler=\"/predict\"}[5m]))",
                            "legendFormat": "p99",
                            "refId": "C"
                          }
                        ],
                        "title": "Prediction Latency",
                        "type": "timeseries"
                      },
                      {
                        "datasource": {
                          "type": "prometheus",
                          "uid": "prometheus"
                        },
                        "fieldConfig": {
                          "defaults": {
                            "color": {
                              "mode": "thresholds"
                            },
                            "mappings": [],
                            "thresholds": {
                              "mode": "absolute",
                              "steps": [
                                {
                                  "color": "green",
                                  "value": null
                                }
                              ]
                            }
                          },
                          "overrides": []
                        },
                        "gridPos": {
                          "h": 4,
                          "w": 6,
                          "x": 0,
                          "y": 8
                        },
                        "id": 3,
                        "options": {
                          "colorMode": "value",
                          "graphMode": "area",
                          "justifyMode": "auto",
                          "orientation": "auto",
                          "reduceOptions": {
                            "calcs": ["lastNotNull"],
                            "fields": "",
                            "values": false
                          },
                          "textMode": "auto"
                        },
                        "targets": [
                          {
                            "datasource": {
                              "type": "prometheus",
                              "uid": "prometheus"
                            },
                            "expr": "sum(increase(predictions_total[24h]))",
                            "legendFormat": "Total",
                            "refId": "A"
                          }
                        ],
                        "title": "Predictions (24h)",
                        "type": "stat"
                      },
                      {
                        "datasource": {
                          "type": "prometheus",
                          "uid": "prometheus"
                        },
                        "fieldConfig": {
                          "defaults": {
                            "color": {
                              "mode": "thresholds"
                            },
                            "mappings": [],
                            "thresholds": {
                              "mode": "absolute",
                              "steps": [
                                {
                                  "color": "green",
                                  "value": null
                                },
                                {
                                  "color": "yellow",
                                  "value": 0.01
                                },
                                {
                                  "color": "red",
                                  "value": 0.05
                                }
                              ]
                            },
                            "unit": "percentunit"
                          },
                          "overrides": []
                        },
                        "gridPos": {
                          "h": 4,
                          "w": 6,
                          "x": 6,
                          "y": 8
                        },
                        "id": 4,
                        "options": {
                          "colorMode": "value",
                          "graphMode": "area",
                          "justifyMode": "auto",
                          "orientation": "auto",
                          "reduceOptions": {
                            "calcs": ["lastNotNull"],
                            "fields": "",
                            "values": false
                          },
                          "textMode": "auto"
                        },
                        "targets": [
                          {
                            "datasource": {
                              "type": "prometheus",
                              "uid": "prometheus"
                            },
                            "expr": "sum(rate(http_requests_total{status=~\"5..\"}[5m])) / sum(rate(http_requests_total[5m]))",
                            "legendFormat": "Error Rate",
                            "refId": "A"
                          }
                        ],
                        "title": "Error Rate",
                        "type": "stat"
                      },
                      {
                        "datasource": {
                          "type": "prometheus",
                          "uid": "prometheus"
                        },
                        "fieldConfig": {
                          "defaults": {
                            "color": {
                              "mode": "thresholds"
                            },
                            "mappings": [
                              {
                                "options": {
                                  "0": {
                                    "color": "red",
                                    "index": 1,
                                    "text": "Not Loaded"
                                  },
                                  "1": {
                                    "color": "green",
                                    "index": 0,
                                    "text": "Loaded"
                                  }
                                },
                                "type": "value"
                              }
                            ],
                            "thresholds": {
                              "mode": "absolute",
                              "steps": [
                                {
                                  "color": "red",
                                  "value": null
                                },
                                {
                                  "color": "green",
                                  "value": 1
                                }
                              ]
                            }
                          },
                          "overrides": []
                        },
                        "gridPos": {
                          "h": 4,
                          "w": 6,
                          "x": 12,
                          "y": 8
                        },
                        "id": 5,
                        "options": {
                          "colorMode": "value",
                          "graphMode": "none",
                          "justifyMode": "auto",
                          "orientation": "auto",
                          "reduceOptions": {
                            "calcs": ["lastNotNull"],
                            "fields": "",
                            "values": false
                          },
                          "textMode": "auto"
                        },
                        "targets": [
                          {
                            "datasource": {
                              "type": "prometheus",
                              "uid": "prometheus"
                            },
                            "expr": "model_loaded",
                            "legendFormat": "Model Status",
                            "refId": "A"
                          }
                        ],
                        "title": "Model Status",
                        "type": "stat"
                      }
                    ],
                    "refresh": "10s",
                    "schemaVersion": 38,
                    "style": "dark",
                    "tags": ["mlops", "api"],
                    "templating": {
                      "list": []
                    },
                    "time": {
                      "from": "now-1h",
                      "to": "now"
                    },
                    "timepicker": {},
                    "timezone": "",
                    "title": "MLOps API Dashboard",
                    "uid": "mlops-api",
                    "version": 1,
                    "weekStart": ""
                  }
        
        # AlertManager
        alertmanager:
          enabled: true
          service:
            type: NodePort
            nodePort: 30903
        
        # Node Exporter (for node metrics)
        nodeExporter:
          enabled: true
        
        # Kube State Metrics
        kubeStateMetrics:
          enabled: true
        
        # Disable some components we don't need
        kubeEtcd:
          enabled: false
        kubeControllerManager:
          enabled: false
        kubeScheduler:
          enabled: false
        kubeProxy:
          enabled: false
  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true

